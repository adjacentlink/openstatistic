Summary: OpenStatistic
Name: openstatistic
Version: @VERSION@
Release: 1%{?dist}
License: BSD
Group: Applications/System
URL: https://github.com/adjacentlink/openstatistic
Source0: %{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
Requires: protobuf
BuildRequires: protobuf-devel
Vendor: Adjacent Link LLC

%if 0%{?fedora} >= 26
%define use_python2 python2
%define use_python2_package python2-openstatistic
%define use_python2_protobuf python2-protobuf
%define use_python2_lxml python2-lxml
%define use_python2_sitelib %{python2_sitelib}
%else
%define use_python2 python
%define use_python2_package python-openstatistic
%define use_python2_protobuf protobuf-python
%define use_python2_lxml python-lxml
%define use_python2_sitelib %{python_sitelib}
%endif

%if 0%{?fedora} >= 26
BuildRequires: python3-devel
%else
%define with_python3 0
%endif

%description
OpenStatistic

%package devel
Summary: OpenStatistic Headers
Group: Development/Libraries
Requires: protobuf-devel openstatistic

%define with_python3 %{?_without_python3:0} %{?!_without_python3:1}

%description devel
OpenStatistic Headers

%package -n %{use_python2_package}
Requires: %{use_python2} %{use_python2_protobuf} %{use_python2_lxml}
Summary: OpenStatistic Python modules
Group: Development/Libraries
BuildArch: noarch
%if 0%{?fedora} >= 26
Obsoletes: python-openstatistic
Provides: python-openstatistic
%endif

%description -n %{use_python2_package}
OpenStatistic Python modules

%package -n python3-openstatistic
Requires: python3-protobuf
Requires: python3-lxml
Summary: OpenStatistic Python modules
Group: Development/Libraries
BuildArch: noarch

%description -n python3-openstatistic
OpenStatistic Python modules

%prep
%setup -q

%build
%configure
make

%if %{with_python3}
# build the python3 version
make -C src/python PYTHON=%{__python3}
%endif

%install
make DESTDIR=${RPM_BUILD_ROOT} install

%if %{with_python3}
make  DESTDIR=${RPM_BUILD_ROOT} -C src/python PYTHON=%{__python3} install
mv %{buildroot}/%{_bindir}/ostatistic %{buildroot}/%{_bindir}/ostatistic-%{python3_version}
ln -s ostatistic-%{python3_version} %{buildroot}/%{_bindir}/ostatistic-3
%endif

make DESTDIR=${RPM_BUILD_ROOT} install -C src/python PYTHON=%{__python2} install
find ${RPM_BUILD_ROOT} -name '*.a' -exec rm '{}'  \;
find ${RPM_BUILD_ROOT} -name '*.la' -exec rm '{}' \;
%if 0%{?el6}
find  ${RPM_BUILD_ROOT} -name "namespace_packages.txt" -exec sh -c "echo ostatistic > {}" \;
%endif
mv %{buildroot}/%{_bindir}/ostatistic %{buildroot}/%{_bindir}/ostatistic-%{python2_version}
ln -s ostatistic-%{python2_version} %{buildroot}/%{_bindir}/ostatistic-2
ln -s ostatistic-2 %{buildroot}/%{_bindir}/ostatistic

%clean
rm -rf $RPM_BUILD_ROOT

%post
/sbin/ldconfig

%postun
/sbin/ldconfig

%files
%defattr(-,root,root,-)
%{_libdir}/*.so

%doc AUTHORS
%doc COPYING
%doc NEWS
%doc README
%doc INSTALL

%files devel
%defattr(-, root, root)
%{_includedir}/*
%{_libdir}/pkgconfig

%files -n %{use_python2_package}
%defattr(-,root,root)
%{use_python2_sitelib}/*
%{_bindir}/ostatistic
%{_bindir}/ostatistic-2*

%if %{with_python3}
%files -n python3-openstatistic
%defattr(-,root,root,-)
%{python3_sitelib}/*
%{_bindir}/ostatistic-3*
%endif

